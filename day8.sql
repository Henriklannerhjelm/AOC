select * into #hl_temp from (select 'acc' as command,33 as factor union all select 'acc',-7 union all select 'acc',+39 union all select 'jmp',+214 union all select 'jmp',+250 union all select 'jmp',+51 union all select 'acc',+29 union all select 'acc',+6 union all select 'acc',+20 union all select 'jmp',+489 union all select 'nop',+181 union all select 'acc',+4 union all select 'jmp',+187 union all select 'nop',+454 union all select 'acc',-10 union all select 'acc',+44 union all select 'jmp',+343 union all select 'acc',+14 union all select 'acc',+24 union all select 'acc',+37 union all select 'acc',-12 union all select 'jmp',+596 union all select 'acc',+21 union all select 'acc',+39 union all select 'jmp',+601 union all select 'acc',-15 union all select 'jmp',+304 union all select 'acc',-7 union all select 'jmp',+302 union all select 'acc',+38 union all select 'jmp',+148 union all select 'acc',-6 union all select 'jmp',+235 union all select 'acc',+6 union all select 'nop',+429 union all select 'acc',+49 union all select 'acc',+3 union all select 'jmp',+255 union all select 'acc',+2 union all select 'jmp',+10 union all select 'acc',+27 union all select 'acc',+0 union all select 'acc',-3 union all select 'acc',+28 union all select 'jmp',+565 union all select 'acc',-16 union all select 'acc',+39 union all select 'acc',-5 union all select 'jmp',+513 union all select 'acc',+43 union all select 'acc',+24 union all select 'jmp',+26 union all select 'nop',+19 union all select 'nop',+71 union all select 'nop',+182 union all select 'jmp',+477 union all select 'acc',+42 union all select 'jmp',+535 union all select 'acc',+38 union all select 'acc',+29 union all select 'acc',+1 union all select 'jmp',+1 union all select 'jmp',+72 union all select 'acc',+25 union all select 'acc',+43 union all select 'acc',+6 union all select 'jmp',+1 union all select 'jmp',+111 union all select 'acc',+43 union all select 'acc',+13 union all select 'jmp',+30 union all select 'acc',+4 union all select 'acc',+24 union all select 'acc',+20 union all select 'acc',-14 union all select 'jmp',+161 union all select 'jmp',+73 union all select 'nop',+108 union all select 'jmp',+547 union all select 'nop',+273 union all select 'acc',-8 union all select 'nop',+358 union all select 'nop',+284 union all select 'jmp',+526 union all select 'acc',+50 union all select 'jmp',+274 union all select 'jmp',+486 union all select 'nop',+167 union all select 'acc',-13 union all select 'jmp',+11 union all select 'acc',+10 union all select 'jmp',+508 union all select 'acc',-11 union all select 'acc',+46 union all select 'acc',+44 union all select 'jmp',+335 union all select 'jmp',+1 union all select 'acc',-16 union all select 'acc',+30 union all select 'jmp',+289 union all select 'acc',+15 union all select 'nop',+265 union all select 'jmp',+1 union all select 'nop',+68 union all select 'jmp',+107 union all select 'acc',-15 union all select 'jmp',-101 union all select 'acc',+28 union all select 'acc',-13 union all select 'jmp',+17 union all select 'acc',+21 union all select 'acc',+46 union all select 'acc',+19 union all select 'acc',-8 union all select 'jmp',+274 union all select 'nop',+237 union all select 'jmp',-111 union all select 'nop',+419 union all select 'acc',+28 union all select 'acc',+26 union all select 'jmp',+275 union all select 'acc',-4 union all select 'jmp',+483 union all select 'jmp',+1 union all select 'jmp',+201 union all select 'jmp',+234 union all select 'acc',+26 union all select 'acc',+21 union all select 'acc',+18 union all select 'jmp',+149 union all select 'acc',+0 union all select 'acc',+29 union all select 'acc',+11 union all select 'jmp',-41 union all select 'nop',+111 union all select 'nop',+212 union all select 'jmp',+172 union all select 'acc',+31 union all select 'acc',+17 union all select 'acc',+6 union all select 'jmp',-40 union all select 'acc',+7 union all select 'acc',+44 union all select 'acc',+41 union all select 'acc',+4 union all select 'jmp',-74 union all select 'acc',-16 union all select 'acc',+37 union all select 'jmp',+119 union all select 'acc',-13 union all select 'acc',+44 union all select 'acc',+21 union all select 'acc',+38 union all select 'jmp',+92 union all select 'acc',+30 union all select 'jmp',+444 union all select 'jmp',+35 union all select 'acc',+3 union all select 'acc',+11 union all select 'acc',+31 union all select 'jmp',-104 union all select 'acc',-10 union all select 'acc',+5 union all select 'acc',+8 union all select 'acc',+31 union all select 'jmp',+127 union all select 'nop',+168 union all select 'acc',+16 union all select 'acc',+6 union all select 'acc',+0 union all select 'jmp',+455 union all select 'acc',+15 union all select 'acc',+0 union all select 'acc',+22 union all select 'acc',-1 union all select 'jmp',+191 union all select 'acc',+16 union all select 'jmp',+56 union all select 'acc',-12 union all select 'acc',+40 union all select 'nop',-140 union all select 'acc',+44 union all select 'jmp',+138 union all select 'acc',+44 union all select 'jmp',+237 union all select 'acc',+15 union all select 'acc',+40 union all select 'jmp',+360 union all select 'acc',+14 union all select 'acc',+14 union all select 'jmp',+185 union all select 'nop',+211 union all select 'acc',+27 union all select 'acc',-8 union all select 'acc',+17 union all select 'jmp',+247 union all select 'acc',+50 union all select 'acc',-2 union all select 'jmp',-49 union all select 'acc',+37 union all select 'jmp',+330 union all select 'acc',+14 union all select 'acc',+44 union all select 'acc',+15 union all select 'nop',-43 union all select 'jmp',+382 union all select 'jmp',-45 union all select 'acc',+46 union all select 'acc',-11 union all select 'acc',+47 union all select 'jmp',+61 union all select 'nop',+252 union all select 'acc',+44 union all select 'acc',-13 union all select 'jmp',+292 union all select 'acc',-6 union all select 'jmp',+199 union all select 'acc',+44 union all select 'acc',+28 union all select 'acc',+17 union all select 'acc',+31 union all select 'jmp',-158 union all select 'acc',-8 union all select 'jmp',+338 union all select 'acc',+0 union all select 'acc',-2 union all select 'nop',+306 union all select 'jmp',-78 union all select 'acc',+11 union all select 'acc',+33 union all select 'acc',+40 union all select 'acc',+33 union all select 'jmp',-169 union all select 'jmp',+273 union all select 'acc',+8 union all select 'jmp',-135 union all select 'acc',+20 union all select 'acc',-14 union all select 'acc',-15 union all select 'nop',+370 union all select 'jmp',+20 union all select 'nop',+51 union all select 'acc',-4 union all select 'acc',-10 union all select 'jmp',-215 union all select 'acc',+22 union all select 'acc',+22 union all select 'jmp',+209 union all select 'acc',+40 union all select 'acc',-18 union all select 'jmp',-158 union all select 'jmp',-130 union all select 'acc',+13 union all select 'jmp',-169 union all select 'nop',+225 union all select 'acc',+7 union all select 'jmp',-23 union all select 'acc',+21 union all select 'acc',+0 union all select 'jmp',+273 union all select 'jmp',+293 union all select 'acc',+39 union all select 'jmp',-71 union all select 'acc',+20 union all select 'jmp',+49 union all select 'acc',+6 union all select 'jmp',-60 union all select 'acc',+35 union all select 'jmp',+84 union all select 'acc',+14 union all select 'jmp',+266 union all select 'acc',+47 union all select 'jmp',-247 union all select 'acc',-3 union all select 'acc',+47 union all select 'acc',+23 union all select 'acc',+30 union all select 'jmp',+105 union all select 'acc',+18 union all select 'jmp',+109 union all select 'jmp',-188 union all select 'nop',-70 union all select 'acc',-2 union all select 'acc',+0 union all select 'jmp',+195 union all select 'acc',+15 union all select 'jmp',+246 union all select 'acc',+49 union all select 'acc',+28 union all select 'jmp',-18 union all select 'nop',+120 union all select 'jmp',+91 union all select 'acc',-15 union all select 'acc',+15 union all select 'acc',+30 union all select 'jmp',+39 union all select 'acc',+46 union all select 'nop',+250 union all select 'acc',+49 union all select 'jmp',-250 union all select 'acc',-10 union all select 'acc',+0 union all select 'acc',+39 union all select 'jmp',-254 union all select 'nop',+55 union all select 'acc',-4 union all select 'acc',-3 union all select 'jmp',+88 union all select 'jmp',+35 union all select 'acc',+47 union all select 'nop',-154 union all select 'acc',-16 union all select 'jmp',+271 union all select 'nop',+253 union all select 'jmp',-199 union all select 'acc',+5 union all select 'acc',+35 union all select 'jmp',+1 union all select 'acc',+49 union all select 'jmp',+234 union all select 'acc',+27 union all select 'acc',+33 union all select 'acc',-3 union all select 'jmp',-138 union all select 'jmp',-107 union all select 'acc',-11 union all select 'acc',+47 union all select 'acc',+14 union all select 'jmp',-288 union all select 'jmp',-205 union all select 'acc',+0 union all select 'jmp',+191 union all select 'acc',-15 union all select 'jmp',-116 union all select 'acc',+35 union all select 'nop',+121 union all select 'acc',+2 union all select 'acc',-14 union all select 'jmp',+223 union all select 'acc',+33 union all select 'acc',-10 union all select 'acc',+24 union all select 'jmp',+73 union all select 'acc',+39 union all select 'jmp',+255 union all select 'acc',+19 union all select 'jmp',-16 union all select 'nop',+1 union all select 'jmp',-177 union all select 'nop',+107 union all select 'nop',-194 union all select 'jmp',+260 union all select 'acc',-16 union all select 'acc',-12 union all select 'jmp',-148 union all select 'acc',+11 union all select 'acc',+18 union all select 'acc',+33 union all select 'jmp',+84 union all select 'acc',+27 union all select 'acc',-13 union all select 'acc',+36 union all select 'acc',+26 union all select 'jmp',+100 union all select 'nop',-110 union all select 'jmp',-98 union all select 'acc',-2 union all select 'acc',+29 union all select 'acc',+25 union all select 'acc',-8 union all select 'jmp',+128 union all select 'acc',+16 union all select 'acc',+1 union all select 'acc',+7 union all select 'jmp',-290 union all select 'acc',+18 union all select 'nop',-235 union all select 'acc',+0 union all select 'jmp',-127 union all select 'acc',-18 union all select 'acc',+38 union all select 'jmp',-297 union all select 'acc',+19 union all select 'acc',-8 union all select 'acc',+20 union all select 'acc',+3 union all select 'jmp',-230 union all select 'jmp',-67 union all select 'jmp',+124 union all select 'acc',-15 union all select 'acc',+26 union all select 'acc',-19 union all select 'jmp',+120 union all select 'jmp',+173 union all select 'jmp',-338 union all select 'acc',-15 union all select 'jmp',-309 union all select 'acc',+19 union all select 'acc',+26 union all select 'acc',+18 union all select 'acc',+8 union all select 'jmp',-6 union all select 'acc',-7 union all select 'acc',+10 union all select 'jmp',-375 union all select 'acc',+5 union all select 'acc',-16 union all select 'acc',+18 union all select 'acc',+46 union all select 'jmp',-309 union all select 'acc',+48 union all select 'acc',+40 union all select 'nop',-227 union all select 'jmp',-380 union all select 'jmp',-290 union all select 'acc',+46 union all select 'acc',+5 union all select 'jmp',-154 union all select 'acc',-9 union all select 'acc',+15 union all select 'jmp',-187 union all select 'acc',-10 union all select 'acc',+0 union all select 'acc',+28 union all select 'acc',+30 union all select 'jmp',-284 union all select 'acc',+43 union all select 'acc',+25 union all select 'acc',+14 union all select 'jmp',-205 union all select 'acc',-13 union all select 'acc',+1 union all select 'nop',-340 union all select 'jmp',-326 union all select 'jmp',+1 union all select 'acc',+9 union all select 'acc',+17 union all select 'acc',+1 union all select 'jmp',-346 union all select 'jmp',-158 union all select 'acc',+23 union all select 'jmp',-26 union all select 'nop',-257 union all select 'jmp',+140 union all select 'acc',+11 union all select 'acc',+10 union all select 'acc',+29 union all select 'acc',+48 union all select 'jmp',+177 union all select 'acc',+28 union all select 'acc',-12 union all select 'acc',-19 union all select 'acc',+37 union all select 'jmp',+79 union all select 'acc',-14 union all select 'jmp',-184 union all select 'nop',+153 union all select 'jmp',-170 union all select 'acc',-17 union all select 'acc',+10 union all select 'acc',-6 union all select 'nop',-174 union all select 'jmp',-391 union all select 'jmp',+148 union all select 'acc',+50 union all select 'acc',-8 union all select 'jmp',-426 union all select 'jmp',+1 union all select 'acc',+16 union all select 'jmp',+20 union all select 'jmp',+1 union all select 'jmp',-217 union all select 'nop',+84 union all select 'jmp',+71 union all select 'acc',+16 union all select 'acc',-7 union all select 'acc',+23 union all select 'acc',+24 union all select 'jmp',-329 union all select 'acc',+9 union all select 'acc',-7 union all select 'acc',-4 union all select 'nop',+117 union all select 'jmp',-16 union all select 'acc',+30 union all select 'nop',-222 union all select 'acc',+32 union all select 'acc',+9 union all select 'jmp',-175 union all select 'acc',+18 union all select 'acc',+15 union all select 'acc',+41 union all select 'jmp',-192 union all select 'acc',-3 union all select 'acc',+8 union all select 'acc',-13 union all select 'acc',+24 union all select 'jmp',-210 union all select 'acc',+17 union all select 'acc',-7 union all select 'acc',-19 union all select 'jmp',+76 union all select 'acc',+26 union all select 'acc',+2 union all select 'acc',+4 union all select 'jmp',+27 union all select 'jmp',-104 union all select 'acc',+38 union all select 'acc',+46 union all select 'nop',-67 union all select 'nop',+37 union all select 'jmp',-186 union all select 'jmp',+5 union all select 'acc',+37 union all select 'acc',+8 union all select 'acc',+30 union all select 'jmp',-409 union all select 'acc',+44 union all select 'acc',+4 union all select 'jmp',+109 union all select 'nop',-8 union all select 'jmp',-395 union all select 'acc',+20 union all select 'acc',+12 union all select 'acc',+16 union all select 'acc',+9 union all select 'jmp',-87 union all select 'nop',-406 union all select 'acc',-8 union all select 'jmp',-209 union all select 'jmp',-137 union all select 'jmp',-179 union all select 'acc',+44 union all select 'jmp',-399 union all select 'nop',-141 union all select 'jmp',+18 union all select 'jmp',+1 union all select 'nop',+55 union all select 'jmp',+39 union all select 'acc',+20 union all select 'acc',+40 union all select 'acc',+44 union all select 'acc',+45 union all select 'jmp',+74 union all select 'acc',-16 union all select 'jmp',-170 union all select 'jmp',-48 union all select 'jmp',-537 union all select 'acc',-9 union all select 'acc',+6 union all select 'nop',-101 union all select 'acc',+2 union all select 'jmp',-418 union all select 'jmp',-81 union all select 'jmp',+1 union all select 'jmp',-338 union all select 'nop',+43 union all select 'acc',+20 union all select 'jmp',-109 union all select 'acc',-1 union all select 'jmp',-343 union all select 'acc',+29 union all select 'acc',+11 union all select 'nop',-439 union all select 'jmp',-310 union all select 'jmp',-374 union all select 'acc',+33 union all select 'nop',+25 union all select 'acc',-16 union all select 'nop',-333 union all select 'jmp',-14 union all select 'jmp',-5 union all select 'jmp',-162 union all select 'nop',-432 union all select 'acc',+16 union all select 'acc',+17 union all select 'jmp',-87 union all select 'acc',-16 union all select 'nop',-265 union all select 'acc',+20 union all select 'jmp',-356 union all select 'acc',+0 union all select 'jmp',+5 union all select 'acc',+39 union all select 'acc',-15 union all select 'jmp',-325 union all select 'jmp',-39 union all select 'nop',-376 union all select 'nop',-116 union all select 'acc',+38 union all select 'jmp',-175 union all select 'jmp',-450 union all select 'jmp',+1 union all select 'acc',+19 union all select 'jmp',-58 union all select 'nop',-39 union all select 'acc',+40 union all select 'acc',+42 union all select 'jmp',-232 union all select 'acc',-14 union all select 'jmp',-17 union all select 'acc',+4 union all select 'acc',-9 union all select 'acc',+45 union all select 'jmp',-229 union all select 'jmp',-18 union all select 'acc',+13 union all select 'acc',+17 union all select 'jmp',-591 union all select 'jmp',-604 union all select 'jmp',-356 union all select 'acc',+1 union all select 'acc',+18 union all select 'nop',-52 union all select 'acc',+39 union all select 'jmp',-361 union all select 'jmp',-303 union all select 'acc',+8 union all select 'nop',-477 union all select 'acc',+3 union all select 'acc',-8 union all select 'jmp',-404 union all select 'acc',+24 union all select 'acc',+5 union all select 'jmp',-88 union all select 'acc',+27 union all select 'jmp',-54 union all select 'jmp',-18 union all select 'acc',+31 union all select 'acc',+40 union all select 'acc',+18 union all select 'acc',-16 union all select 'jmp',+1 )t
Alter Table #hl_temp Add Id Int Identity(1, 1)

--#1
;WITH Commands AS
(
    SELECT n = 1, newPos=2,0 as oldacc,factor as acc
	from #hl_temp h1 where id=1
    UNION ALL
	select  n=n+1,newPos=newPos+CASE WHEN h1.COMMAND='jmp' then factor ELSE 1 end,acc,acc=acc+PATINDEX('acc',h1.command)*h1.factor
	from Commands INNER JOIN #hl_temp h1 on h1.id=newPos where  n+1 <= 650 
)
SELECT TOP 1 c2.oldacc FROM Commands c1  INNER JOIN Commands c2 on c1.newPos=c2.newPos and c1.n<c2.n OPTION (MAXRECURSION 650) 

-- prepare #2
SELECT command,factor,cast(id as int) as id INTO #hl_temp2 from #hl_temp where id=-1

DECLARE @MyCursor CURSOR, @MyField int,@ROWCOUNT INT = 1;
SET @MyCursor = CURSOR FOR  SELECT id FROM #hl_temp where command in ('nop','jmp') 
OPEN @MyCursor 
FETCH NEXT FROM @MyCursor INTO @MyField 
WHILE @@FETCH_STATUS = 0 AND @ROWCOUNT>0
BEGIN
    TRUNCATE TABLE #hl_temp2
	INSERT INTO #hl_temp2 SELECT case when id = @MyField THEN CASE WHEN command='nop' then 'jmp' else 'nop' END ELSE COMMAND END,factor,cast(id as int) from #hl_temp

	;WITH Commands AS
	(
		SELECT n = 1, newPos=2,0 as oldacc,factor as acc,id as pos,h1.command,h1.factor as f
		from #hl_temp2 h1 where id=1
		UNION ALL
		select  n=n+1,newPos=newPos+CASE WHEN h1.COMMAND='jmp' then factor ELSE 1 end,acc,acc=acc+PATINDEX('acc',h1.command)*h1.factor, id ,h1.command,h1.factor
		from Commands INNER JOIN #hl_temp2 h1 on h1.id=newPos where  n+1 <= 1600 
	) 
	SELECT @ROWCOUNT = COUNT(1) from Commands c1  INNER join Commands c2 on c1.newPos=c2.newPos and c1.n<c2.n OPTION (MAXRECURSION 1610) 
	
    FETCH NEXT FROM @MyCursor 
    INTO @MyField 
END; 
CLOSE @MyCursor ;
DEALLOCATE @MyCursor;
	

--#2
;WITH Commands AS
(
    SELECT n = 1, newPos=2,0 as oldacc,factor as acc,id as pos,h1.command,h1.factor as f
	from #hl_temp2 h1 where id=1
    UNION ALL
	select  n=n+1,newPos=newPos+CASE WHEN h1.COMMAND='jmp' then factor ELSE 1 end,acc,acc=acc+PATINDEX('acc',h1.command)*h1.factor, id ,h1.command,h1.factor
	from Commands INNER JOIN #hl_temp2 h1 on h1.id=newPos where  n+1 <= 1000 
)
select top 1 acc from Commands c1 order by n desc
OPTION (MAXRECURSION 1000) 
